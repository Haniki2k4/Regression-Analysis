---
title: "Báo Cáo Sơ Bộ - Môi Trường Sống và Sức Khỏe Hộ Gia Đình"
author: "Nhóm 5"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: kable
---

```{css, echo=FALSE}
    body {
      font-size: 16px;
      font-family: Times New Roman;
    }
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.width = 7,
  fig.height = 5
)

# Thư viện cần thiết
library(haven)      # đọc file .sav
library(dplyr)      # xử lý dữ liệu
library(ggplot2)    # trực quan hóa
library(janitor)    # tabyl tần số
library(tidyr)      # reshape dữ liệu
library(scales)     # hiển thị %
library(knitr)
library(kableExtra)
```

### **Chủ đề nghiên cứu:** Mối liên quan giữa điều kiện vệ sinh, nguồn nước, và sức khỏe của các thành viên trong hộ gia đình.

**Câu hỏi nghiên cứu:**

1.  Mô tả tỷ lệ các hộ gia đình được tiếp cận với nguồn nước sạch và nhà tiêu hợp vệ sinh. Trực quan hóa sự chênh lệch về các chỉ số này giữa khu vực thành thị và nông thôn.
2.  Kiểm định giả thuyết: Liệu các hộ gia đình sử dụng nguồn nước không an toàn có tỷ lệ trẻ em (\< 5 tuổi) bị tiêu chảy cao hơn so với các hộ gia đình dùng nước sạch hay không?
3.  Xây dựng mô hình hồi quy logistic để xác định các yếu tố kinh tế - xã hội (mức sống, trình độ học vấn của chủ hộ) dự đoán khả năng một hộ gia đình sở hữu nhà tiêu hợp vệ sinh.

## **1. Kết quả làm sạch dữ liệu**

```{r load-data, results = 'hide'}
# Chỉ lấy các biến cần thiết
hh <- read_sav("E:/regression-analysis/final-exam/Viet Nam MICS6 Datasets/Viet Nam MICS6 SPSS Datasets/hh.sav") %>% 
  select(WS1, WS11, HH6, windex5, helevel, HC2, HH2, HH1)

ch <- read_sav("E:/regression-analysis/final-exam/Viet Nam MICS6 Datasets/Viet Nam MICS6 SPSS Datasets/ch.sav") %>% 
  select(HH1, HH2, CA1)
```

Xử lý missing:

-   Các biến có tỷ lệ thiếu nhỏ hơn 5% được loại bỏ trực tiếp bằng drop_na() để đảm bảo tính toàn vẹn dữ liệu.

-   Những dòng bị loại chủ yếu là các hộ không có thông tin đầy đủ về nguồn nước hoặc nhà tiêu.

    ```{r find_mising}
    # Kiểm tra missing
    hh %>% summarise(across(everything(), ~ mean(is.na(.)) * 100))
    ch %>% summarise(across(everything(), ~ mean(is.na(.)) * 100))

    ```

Số lượng giá trị missing đã được loại bỏ trong các file dữ liệu:

```{r op-missing}
# Loại bỏ missing
hh_clean <- hh %>% drop_na()
ch_clean <- ch %>% drop_na()

# Số dòng trước và sau của hh
hh_before <- nrow(hh)
hh_after  <- nrow(hh_clean)

# Số dòng trước và sau của ch
ch_before <- nrow(ch)
ch_after  <- nrow(ch_clean)

# Gộp thành 1 bảng
summary_table <- tibble(
  dataset     = c("hh.sav", "ch.sav"),
  rows_before = c(hh_before, ch_before),
  rows_after  = c(hh_after, ch_after),
  dropped     = c(hh_before - hh_after,
                  ch_before - ch_after)
)

kable(summary_table, caption="Bảng 1. Số dòng trước và sau khi xử lý missing") %>%
  kable_styling(full_width=FALSE)

```

```{r create-vars, f}
# Biến tiêu chảy ở trẻ
ch_clean <- ch_clean %>% 
  mutate(diarrhea = if_else(CA1 == 1, 1, 0))

# Gom theo hộ: hộ có ít nhất 1 trẻ bị tiêu chảy
diarrhea_hh <- ch_clean %>% 
  group_by(HH1, HH2) %>% 
  summarise(any_diarrhea = max(diarrhea, na.rm = TRUE), .groups = "drop")

# Ghép vào dữ liệu hộ
hh_clean <- hh_clean %>% 
  left_join(diarrhea_hh, by = c("HH1", "HH2"))

# Biến safe_water từ WS1 và improved_sanitation từ WS11
hh_clean <- hh_clean %>% 
  mutate(
    safe_water = case_when(
      WS1 %in% c(11,12,13,14,21,31,41,72,91,92) ~ 1,
      WS1 %in% c(32,42,51,61,71,81,96,99) ~ 0,
      TRUE ~ NA_real_
    ),
    improved_sanitation = case_when(
      WS11 %in% c(11,12,21,22,31) ~ 1,
      WS11 %in% c(13,14,18,23,41,51,95,96,99) ~ 0,
      TRUE ~ NA_real_
    )
  )

```

Các biến mới đã được tạo:

-   Biến diarrhea: bằng 1 nếu trẻ trong hộ được báo cáo là bị tiêu chảy trong vòng 2 tuần trước khảo sát, bằng 0 nếu không bị.

-   Biến any_diarrhea: bằng 1 nếu trong hộ có ít nhất một trẻ bị tiêu chảy, bằng 0 nếu không có.

-   Biến safe_water: bằng 1 nếu nguồn nước sinh hoạt thuộc nhóm an toàn (nước máy, giếng khoan), bằng 0 nếu không thuộc nhóm an toàn (nước, sông, ao hồ).

-   Biến improved_sanitation: bằng 1 nếu hộ có nhà tiêu hợp vệ sinh và bằng 0 nếu không có.

## **2. Thống kê mô tả và trực quan hóa**

```{r descriptives}
# Tần số nước sạch & nhà tiêu
tabyl(hh_clean, safe_water) %>%
  mutate(safe_water = case_when(
    safe_water == 1 ~ "Có",
    safe_water == 0 ~ "Không",
    TRUE ~ as.character(safe_water)
  )) %>%
  kable(caption = "Bảng 2. Tần số hộ có nước sạch",
        align = "lcc")

# Bảng Improved Sanitation
tabyl(hh_clean, improved_sanitation) %>%
  mutate(improved_sanitation = case_when(
    improved_sanitation == 1 ~ "Có",
    improved_sanitation == 0 ~ "Không",
    TRUE ~ as.character(improved_sanitation)
  )) %>%
  kable(caption = "Bảng 3. Tần số hộ có nhà tiêu hợp vệ sinh",
        align = "lcc") 
```

*Nhận xét:* Hơn 85% hộ sử dụng nguồn nước an toàn và gần 88% hộ có nhà tiêu hợp vệ sinh, cho thấy điều kiện vệ sinh nhìn chung khá tốt.

### *Biểu đồ tròn tỷ lệ* {.tabset .tabset-fade .tabset-pills}

#### Tỷ lệ hộ sử dụng nước sạch

```{r pie-safe-water, echo=FALSE}
safe_tab <- hh_clean %>% 
  filter(!is.na(safe_water)) %>% 
  count(safe_water) %>% 
  mutate(pct = round(n / sum(n) * 100, 1),
         label = paste0(pct, "%"))

ggplot(safe_tab, aes(x = "", y = n, fill = factor(safe_water))) +
  geom_col(width = 1) +
  coord_polar(theta = "y") +
  geom_text(aes(label = label),
            position = position_stack(vjust = 0.5), size = 4) +
  labs(
    fill = "Nước sạch (0=Không, 1=Có)",
    title = "Tỷ lệ hộ sử dụng nguồn nước an toàn"
  ) +
  theme_void()
```

#### Tỷ lệ hộ có nhà tiêu hợp vệ sinh

```{r pie-sanitation, echo=FALSE}
san_tab <- hh_clean %>% 
  filter(!is.na(improved_sanitation)) %>% 
  count(improved_sanitation) %>% 
  mutate(pct = round(n / sum(n) * 100, 1),
         label = paste0(pct, "%"))

ggplot(san_tab, aes(x = "", y = n, fill = factor(improved_sanitation))) +
  geom_col(width = 1) +
  coord_polar(theta = "y") +
  geom_text(aes(label = label),
            position = position_stack(vjust = 0.5), size = 4) +
  labs(
    fill = "Nhà tiêu hợp vệ sinh (0=Không, 1=Có)",
    title = "Tỷ lệ hộ có nhà tiêu hợp vệ sinh"
  ) +
  theme_void()
```

### *Biểu đồ cột so sánh theo khu vực* {.tabset .tabset-fade .tabset-pills}

#### Nước sạch

```{r bar-area-safe, echo=FALSE}
# Nước sạch theo khu vực
water_by_area <- hh_clean %>% 
  filter(!is.na(safe_water)) %>% 
  group_by(HH6, safe_water) %>% 
  summarise(n = n(), .groups = "drop") %>% 
  group_by(HH6) %>% 
  mutate(pct = n / sum(n) * 100)

ggplot(water_by_area, aes(x = factor(HH6), y = pct, fill = factor(safe_water))) +
  geom_col() +
  geom_text(aes(label = paste0(round(pct,1), "%")),
            position = position_stack(vjust = 0.5),
            color = "white", size = 4) +
  labs(
    title = "Tỷ lệ hộ sử dụng nước sạch theo khu vực",
    x = "Khu vực (1=Thành thị, 2=Nông thôn)", y = "Tỷ lệ (%)",
    fill = "Nước sạch (0=Không, 1=Có)"
  ) +
  theme_minimal()
```

#### Nhà tiêu hợp vệ sinh

```{r bar-area-san, echo=FALSE}
# Nhà tiêu theo khu vực
san_by_area <- hh_clean %>% 
  filter(!is.na(improved_sanitation)) %>% 
  group_by(HH6, improved_sanitation) %>% 
  summarise(n = n(), .groups = "drop") %>% 
  group_by(HH6) %>% 
  mutate(pct = n / sum(n) * 100)

ggplot(san_by_area, aes(x = factor(HH6), y = pct, fill = factor(improved_sanitation))) +
  geom_col() +
  geom_text(aes(label = paste0(round(pct,1), "%")),
            position = position_stack(vjust = 0.5),
            color = "white", size = 4) +
  labs(
    title = "Tỷ lệ hộ có nhà tiêu hợp vệ sinh theo khu vực",
    x = "Khu vực (1=Thành thị, 2=Nông thôn)", y = "Tỷ lệ (%)",
    fill = "Nhà tiêu hợp vệ sinh (0=Không, 1=Có)"
  ) +
  theme_minimal()
```

## **3. Kết quả phân tích hai biến**

### Kiểm định Chi-squared

```{r chi-square}
chisq_res <- chisq.test(hh_clean$safe_water, hh_clean$any_diarrhea)
knitr::kable(as.data.frame(chisq_res$observed),
             caption="Bảng 4. Bảng chéo giữa Nước sạch và Tiêu chảy")
chisq_res
```

### Phân tích hồi quy logistic

[Bảng 5. Kết quả hồi quy logistic (Odds Ratio)]{style="color: gray;"}

```{r regression}
# Hồi quy logistic
model <- glm(improved_sanitation ~ windex5 + helevel + HH6 + HC2,
             data = hh_clean,
             family = binomial)

summary(model) 
```

------------------------------------------------------------------------
