---
title: "Báo Cáo Sơ Bộ - Môi Trường Sống và Sức Khỏe Hộ Gia Đình"
author: "Nhóm 5"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: kable
---

```{css, echo=FALSE}
    body {
      font-size: 16px;
      font-family: Calibri;
    }
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.width = 7,
  fig.height = 5
)

# Thư viện cần thiết
library(haven)      # đọc file .sav
library(dplyr)      # xử lý dữ liệu
library(ggplot2)    # trực quan hóa
library(janitor)    # tabyl tần số
library(tidyr)      # reshape dữ liệu
library(scales)     # hiển thị %
library(knitr)
library(kableExtra)
library(MASS)
```

### **Chủ đề nghiên cứu:** Mối liên quan giữa điều kiện vệ sinh, nguồn nước, và sức khỏe của các thành viên trong hộ gia đình.

**Câu hỏi nghiên cứu:**

1.  Mô tả tỷ lệ các hộ gia đình được tiếp cận với nguồn nước sạch và nhà tiêu hợp vệ sinh. Trực quan hóa sự chênh lệch về các chỉ số này giữa khu vực thành thị và nông thôn.
2.  Kiểm định giả thuyết: Liệu các hộ gia đình sử dụng nguồn nước không an toàn có tỷ lệ trẻ em (\< 5 tuổi) bị tiêu chảy cao hơn so với các hộ gia đình dùng nước sạch hay không?
3.  Xây dựng mô hình hồi quy logistic để xác định các yếu tố kinh tế - xã hội (mức sống, trình độ học vấn của chủ hộ) dự đoán khả năng một hộ gia đình sở hữu nhà tiêu hợp vệ sinh.

**Mô tả số liệu:**

Bộ dữ liệu được lấy từ khảo sát MICS 6 (2021) của UNICEF tại Việt Nam, bao gồm các thông tin về hộ gia đình, trẻ em và các yếu tố liên quan đến sức khỏe cộng đồng.

Các biến số chính được sử dụng

-   Biến phụ thuộc:

    -   WS11: Loại nhà vệ sinh của hộ gia đình.

    -   WS1: Nguồn nước uống chính của hộ gia đình

    -   CA1: Trẻ có bị tiêu chảy trong 2 tuần qua không.

-   Biến độc lập:

    -   HH6: Khu vực sinh sống

    -   windex5: Mức sống kinh tế của hộ gia đình

    -   windex5r: Mức sống kinh tế của hộ gia đình ở nông thôn

    -   windex5u: Mức sống kinh tế của hộ gia đình ở thành thị

    -   helevel: Trình độ học vấn của chủ hộ

    -   HC2: Dân tộc chủ hộ

## **1. Kết quả làm sạch dữ liệu**

```{r load-data, results = 'hide'}
# Chỉ lấy các biến cần thiết
hh <- read_sav("E:/regression-analysis/final-exam/Viet Nam MICS6 Datasets/Viet Nam MICS6 SPSS Datasets/hh.sav") %>%
  dplyr::select(HH1, HH2, HH6, WS1, WS11, helevel, HC2, windex5, windex5r, windex5u)

ch <- read_sav("E:/regression-analysis/final-exam/Viet Nam MICS6 Datasets/Viet Nam MICS6 SPSS Datasets/ch.sav") %>% 
  dplyr::select(HH1, HH2, CA1)
```

Xử lý missing:

-   Các biến có tỷ lệ thiếu nhỏ hơn 5% được loại bỏ trực tiếp bằng drop_na() để đảm bảo tính toàn vẹn dữ liệu.

-   Những dòng bị loại chủ yếu là các hộ không có thông tin đầy đủ về nguồn nước hoặc nhà tiêu.

```{r find_mising}
# Kiểm tra missing
hh_missing <- hh %>% summarise(across(everything(), ~ mean(is.na(.)) * 100))
ch_missing <- ch %>% summarise(across(everything(), ~ mean(is.na(.)) * 100))

kable(hh_missing)
kable(ch_missing, caption="Bảng 1. Tỷ lệ thiếu của các biến trong file hh.sav và ch.sav")

```

Số lượng giá trị missing đã được loại bỏ trong các file dữ liệu:

```{r op-missing}
# Xử lý missing: thay bằng median, nhưng KHÔNG động đến windex5r và windex5u
hh_clean <- hh %>%
  mutate(across(
    .cols = c(where(is.numeric), -c(windex5r, windex5u)),
    .fns  = ~ if_else(is.na(.), median(., na.rm = TRUE), .)
  ))

ch_clean <- ch %>%
  mutate(across(where(is.numeric),
                ~ if_else(is.na(.),
                          median(., na.rm = TRUE),
                          .)))

```


```{r create-vars, f}
# Biến tiêu chảy ở trẻ
ch_clean <- ch_clean %>% 
  mutate(diarrhea = if_else(CA1 == 1, 1, 0))

# Gom theo hộ: hộ có ít nhất 1 trẻ bị tiêu chảy
diarrhea_hh <- ch_clean %>% 
  group_by(HH1, HH2) %>% 
  summarise(any_diarrhea = max(diarrhea, na.rm = TRUE), .groups = "drop")

# Ghép vào dữ liệu hộ
hh_clean <- hh_clean %>% 
  left_join(diarrhea_hh, by = c("HH1", "HH2"))

# Biến safe_water từ WS1 và improved_sanitation từ WS11
hh_clean <- hh_clean %>% 
  mutate(
    safe_water = case_when(
      WS1 %in% c(11,12,13,14,21,31,41,51,72,91,92) ~ 1,
      WS1 %in% c(32,42,61,71,81,96,99) ~ 0,
      TRUE ~ NA_real_
    ),
    improved_sanitation = case_when(
      WS11 %in% c(11,12,21,22,31) ~ 1,
      WS11 %in% c(13,14,18,23,41,51,95,96,99) ~ 0,
      TRUE ~ NA_real_
    )
  )

```

Các biến mới đã được tạo:

-   Biến diarrhea: bằng 1 nếu trẻ trong hộ được báo cáo là bị tiêu chảy trong vòng 2 tuần trước khảo sát, bằng 0 nếu không bị.

-   Biến any_diarrhea: bằng 1 nếu trong hộ có ít nhất một trẻ bị tiêu chảy, bằng 0 nếu không có.

-   Biến safe_water: bằng 1 nếu nguồn nước sinh hoạt thuộc nhóm an toàn (nước máy, giếng khoan), bằng 0 nếu không thuộc nhóm an toàn (nước, sông, ao hồ).

-   Biến improved_sanitation: bằng 1 nếu hộ có nhà tiêu hợp vệ sinh và bằng 0 nếu không có.

## **2. Thống kê mô tả và trực quan hóa**

```{r descriptives}
# Tần số nước sạch & nhà tiêu
tabyl(hh_clean, safe_water) %>%
  mutate(safe_water = case_when(
    safe_water == 1 ~ "Có",
    safe_water == 0 ~ "Không",
    TRUE ~ as.character(safe_water)
  )) %>%
  kable(caption = "Bảng 2. Tần số hộ có nước sạch",
        align = "lcc")

# Bảng Improved Sanitation
tabyl(hh_clean, improved_sanitation) %>%
  mutate(improved_sanitation = case_when(
    improved_sanitation == 1 ~ "Có",
    improved_sanitation == 0 ~ "Không",
    TRUE ~ as.character(improved_sanitation)
  )) %>%
  kable(caption = "Bảng 3. Tần số hộ có nhà tiêu hợp vệ sinh",
        align = "lcc") 
```

*Nhận xét:* Hơn 96% hộ sử dụng nguồn nước an toàn và gần 79% hộ có nhà tiêu hợp vệ sinh, cho thấy điều kiện vệ sinh nhìn chung khá tốt.

### *Biểu đồ tròn tỷ lệ* {.tabset .tabset-fade .tabset-pills}

#### Tỷ lệ hộ sử dụng nước sạch

```{r pie-safe-water, echo=FALSE}
safe_tab <- hh_clean %>% 
  filter(!is.na(safe_water)) %>% 
  count(safe_water) %>% 
  mutate(pct = round(n / sum(n) * 100, 1),
         label = paste0(pct, "%"))

ggplot(safe_tab, aes(x = "", y = n, fill = factor(safe_water))) +
  geom_col(width = 1) +
  coord_polar(theta = "y") +
  geom_text(aes(label = label),
            position = position_stack(vjust = 0.5),
            color = "white", size = 4) +
  scale_fill_manual(
    name = "Nước sạch",
    values = c("0" = "#e74c3c", "1" = "#2ecc71"),  # màu: đỏ/ xanh
    labels = c("0" = "Không", "1" = "Có")         # đổi nhãn
  ) +
  labs(title = "Tỉ lệ hộ sử dụng nguồn nước an toàn tại Việt Nam năm 2021") +
  theme_void()
```

**Nhận xét:** Phần lớn các hộ gia đình (96%) có nguồn nước sử dụng an toàn.Tuy nhiên, vẫn còn 4% hộ chưa được tiếp cận nước sạch -\> các hộ này có nguy cơ cao gặp các vấn đề về sức khỏe, bệnh tật do nguồn nước ô nhiễm

#### Tỷ lệ hộ có nhà tiêu hợp vệ sinh

```{r pie-sanitation, echo=FALSE}
san_tab <- hh_clean %>% 
  filter(!is.na(improved_sanitation)) %>% 
  count(improved_sanitation) %>% 
  mutate(pct = round(n / sum(n) * 100, 1),
         label = paste0(pct, "%"))

ggplot(san_tab, aes(x = "", y = n, fill = factor(improved_sanitation))) +
  geom_col(width = 1) +
  coord_polar(theta = "y") +
  geom_text(aes(label = label),
            position = position_stack(vjust = 0.5),
            color = "white", size = 4) +
  scale_fill_manual(
    name = "Nhà tiêu hợp vệ sinh",
    values = c("0" = "#e67e22", "1" = "#3498db"),
    labels = c("0" = "Không", "1" = "Có")
  ) +
  labs(title = "Tỉ lệ hộ có Nhà tiêu hợp vệ sinh tại Việt Nam năm 2021") +
  theme_void()
```

**Nhận xét:** Khoảng 79.4% hộ có nhà tiêu hợp vệ sinh. Tuy nhiên còn 20.6% hộ chưa có công trình vệ sinh hợp chuẩn -\> có thể gây ô nhiễm môi trường và lây lan bệnh tật.

### *Biểu đồ cột so sánh theo khu vực* {.tabset .tabset-fade .tabset-pills}

#### Nước sạch

```{r bar-area-safe, echo=FALSE}
# Nước sạch theo khu vực
water_by_area <- hh_clean %>% 
  filter(!is.na(safe_water)) %>% 
  group_by(HH6, safe_water) %>% 
  summarise(n = n(), .groups = "drop") %>% 
  group_by(HH6) %>% 
  mutate(pct = n / sum(n) * 100)

ggplot(water_by_area, aes(x = factor(HH6), y = pct, fill = factor(safe_water))) +
  geom_col() +
  geom_text(aes(label = paste0(round(pct,1), "%")), 
            position = position_stack(vjust = 0.5),
            color = "white", size = 4) +
  scale_fill_manual(
    name = "Nước sạch",
    values = c("0" = "#e74c3c", "1" = "#2ecc71"),  # màu đỏ và xanh
    labels = c("0" = "Không", "1" = "Có")         # nhãn hiển thị
  ) +
  labs(
    title = "Tỷ lệ hộ có sử dụng Nguồn nước an toàn theo khu vực tại Việt Nam năm 2021",
    x = "Khu vực (1 = Thành thị, 2 = Nông thôn)",
    y = "Tỷ lệ (%)"
  ) +
  theme_minimal()

```

**Nhận xét:** Việt Nam đạt tỷ lệ hộ sử dụng nước sạch rất cao, đặc biệt tại khu vực thành thị.
Tuy nhiên, chênh lệch giữa nông thôn và thành thị (~5%) cho thấy vẫn cần tiếp tục đầu tư và cải thiện hệ thống cấp nước ở nông thôn để đảm bảo công bằng trong tiếp cận nguồn nước an toàn.

#### Nhà tiêu hợp vệ sinh

```{r bar-area-san, echo=FALSE}
# Nhà tiêu theo khu vực
san_by_area <- hh_clean %>% 
  filter(!is.na(improved_sanitation)) %>% 
  group_by(HH6, improved_sanitation) %>% 
  summarise(n = n(), .groups = "drop") %>% 
  group_by(HH6) %>% 
  mutate(pct = n / sum(n) * 100)

ggplot(san_by_area, aes(x = factor(HH6), y = pct, fill = factor(improved_sanitation))) +
  geom_col() +
  geom_text(aes(label = paste0(round(pct,1), "%")), 
            position = position_stack(vjust = 0.5),
            color = "white", size = 4) +
  scale_fill_manual(
    name = "Nhà tiêu hợp vệ sinh",
    values = c("0" = "#e67e22", "1" = "#3498db"),  # màu cam và xanh dương
    labels = c("0" = "Không", "1" = "Có")
  ) +
  labs(
    title = "Tỷ lệ hộ có Nhà tiêu hợp vệ sinh phân theo khu vực tại Việt Nam năm 2021",
    x = "Khu vực (1 = Thành thị, 2 = Nông thôn)",
    y = "Tỷ lệ (%)"
  ) +
  theme_minimal()

```

**Nhận xét:** Khu vực thành thị có điều kiện vệ sinh tốt hơn nhiều so với nông thôn. Tỷ lệ hộ có nhà tiêu hợp vệ sinh ở nông thôn thấp hơn 18.4 % so với thành thị.

## **3. Kết quả phân tích hai biến**

### Kiểm định Chi-squared

```{r chi-square}
chisq_res <- chisq.test(hh_clean$safe_water, hh_clean$any_diarrhea)
knitr::kable(as.data.frame(chisq_res$observed),
             caption="Bảng 4. Bảng chéo giữa Nước sạch và Tiêu chảy")
```

[Bảng 5. Kết quả kiểm định Chi-squared]{style="color: gray;"}

``` {r chi-square-2}
chisq_res
```

**Nhận xét:** p = 0.01291 \< 0.05 -\> Có mối liên hệ thống kê có ý nghĩa giữa việc sử dụng nước sạch và tình trạng tiêu chảy ở trẻ em trong mẫu khảo sát này.

### Phân tích hồi quy logistic

[Bảng 6. Kết quả hồi quy logistic (Odds Ratio)]{style="color: gray;"}

```{r regression}
# Hồi quy logistic
model1 <- glm(improved_sanitation ~ windex5 + helevel + HH6 + HC2,
             data = hh_clean,
             family = binomial)
model2 <- glm(improved_sanitation ~ windex5r + helevel + HH6 + HC2,
             data = hh_clean,
             family = binomial)
model3 <- glm(improved_sanitation ~ windex5u + helevel + HH6 + HC2,
             data = hh_clean,
             family = binomial)

cat("**Bảng x. Kết quả hồi quy logistic với windex5**\n\n")
summary(model1)
cat("**Bảng xx. Kết quả hồi quy logistic với windex5r**\n\n")
summary(model2) 
cat("**Bảng xxx. Kết quả hồi quy logistic với windex5u**\n\n")
summary(model3) 
```

**Nhận xét:**

-  windex5 và helevel có tác động tích cực và có ý nghĩa thống kê cao đến khả năng hộ có nhà tiêu hợp vệ sinh.

-  HH6 và HC2 có hệ số âm và có ý nghĩa thống kê, cho thấy hộ nông thôn và dân tộc thiểu số có khả năng thấp hơn về điều kiện vệ sinh.



------------------------------------------------------------------------
