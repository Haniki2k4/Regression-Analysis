---
title: "Báo Cáo Sơ Bộ - Môi Trường Sống và Sức Khỏe Hộ Gia Đình"
author: "Nhóm 5"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: kable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.width = 7,
  fig.height = 5
)

# Thư viện cần thiết
library(haven)      # đọc file .sav
library(dplyr)      # xử lý dữ liệu
library(ggplot2)    # trực quan hóa
library(janitor)    # tabyl tần số
library(tidyr)      # reshape dữ liệu
library(scales)     # hiển thị %
library(knitr)
library(kableExtra)
```

## **1. Kết quả làm sạch dữ liệu**

```{r load-data, results = 'hide'}
# Chỉ lấy các biến cần thiết
hh <- read_sav("E:/regression-analysis/final-exam/Viet Nam MICS6 Datasets/Viet Nam MICS6 SPSS Datasets/hh.sav") %>% 
  select(WS1, WS11, HH6, windex5, helevel, HC2, HH2, HH1)

ch <- read_sav("E:/regression-analysis/final-exam/Viet Nam MICS6 Datasets/Viet Nam MICS6 SPSS Datasets/ch.sav") %>% 
  select(HH1, HH2, CA1)

# Kiểm tra missing
hh %>% summarise(across(everything(), ~ mean(is.na(.)) * 100))
ch %>% summarise(across(everything(), ~ mean(is.na(.)) * 100))

# Loại bỏ missing
hh_clean <- hh %>% drop_na()
ch_clean <- ch %>% drop_na()
```

Số lượng giá trị missing đã được loại bỏ trong các file dữ liệu:

```{r op-missing}
# Số dòng trước và sau của hh
hh_before <- nrow(hh)
hh_after  <- nrow(hh_clean)

# Số dòng trước và sau của ch
ch_before <- nrow(ch)
ch_after  <- nrow(ch_clean)

# Gộp thành 1 bảng
summary_table <- tibble(
  dataset     = c("hh.sav", "ch.sav"),
  rows_before = c(hh_before, ch_before),
  rows_after  = c(hh_after, ch_after),
  dropped     = c(hh_before - hh_after,
                  ch_before - ch_after)
)

summary_table

```

Các biến mới đã được tạo:

-   Biến diarrhea: bằng 1 nếu trẻ trong hộ được báo cáo là bị tiêu chảy trong vòng 2 tuần trước khảo sát, bằng 0 nếu không bị.

-   Biến any_diarrhea: bằng 1 nếu trong hộ có ít nhất một trẻ bị tiêu chảy, bằng 0 nếu không có.

-   Biến safe_water: bằng 1 nếu nguồn nước sinh hoạt thuộc nhóm an toàn, bằng 0 nếu không thuộc nhóm an toàn.

-   Biến improved_sanitation: bằng 1 nếu hộ có nhà tiêu hợp vệ sinh và bằng 0 nếu không có.

```{r create-vars, f}
# Biến tiêu chảy ở trẻ
ch_clean <- ch_clean %>% 
  mutate(diarrhea = if_else(CA1 == 1, 1, 0))

# Gom theo hộ: hộ có ít nhất 1 trẻ bị tiêu chảy
diarrhea_hh <- ch_clean %>% 
  group_by(HH1, HH2) %>% 
  summarise(any_diarrhea = max(diarrhea, na.rm = TRUE), .groups = "drop")

# Ghép vào dữ liệu hộ
hh_clean <- hh_clean %>% 
  left_join(diarrhea_hh, by = c("HH1", "HH2"))

# Biến safe_water từ WS1 và improved_sanitation từ WS11
hh_clean <- hh_clean %>% 
  mutate(
    safe_water = case_when(
      WS1 %in% c(11,12,13,14,21,31,41,72,91,92) ~ 1,
      WS1 %in% c(32,42,51,61,71,81,96,99) ~ 0,
      TRUE ~ NA_real_
    ),
    improved_sanitation = case_when(
      WS11 %in% c(11,12,13,14,21,22,23,31) ~ 1,
      WS11 %in% c(18,41,51,95,96,99) ~ 0,
      TRUE ~ NA_real_
    )
  )

```

## **2. Thống kê mô tả và trực quan hóa**

```{r descriptives}
# Tần số nước sạch & nhà tiêu
tabyl(hh_clean, safe_water) %>%
  kable(caption = "Bảng tần số hộ gia đình theo biến Safe Water")

# Bảng Improved Sanitation
tabyl(hh_clean, improved_sanitation) %>%
  kable(caption = "Bảng tần số hộ gia đình theo biến Improved Sanitation")
```

### *Biểu đồ tròn tỷ lệ* {.tabset .tabset-fade .tabset-pills}

#### Tỷ lệ hộ sử dụng nước sạch

```{r pie-safe-water, echo=FALSE}
safe_tab <- hh_clean %>% 
  filter(!is.na(safe_water)) %>% 
  count(safe_water) %>% 
  mutate(pct = round(n / sum(n) * 100, 1),
         label = paste0(pct, "%"))

ggplot(safe_tab, aes(x = "", y = n, fill = factor(safe_water))) +
  geom_col(width = 1) +
  coord_polar(theta = "y") +
  geom_text(aes(label = label),
            position = position_stack(vjust = 0.5), size = 4) +
  labs(
    fill = "Nước sạch (0=Không, 1=Có)",
    title = "Tỷ lệ hộ sử dụng nguồn nước an toàn"
  ) +
  theme_void()
```

#### Tỷ lệ hộ có nhà tiêu hợp vệ sinh

```{r pie-sanitation, echo=FALSE}
san_tab <- hh_clean %>% 
  filter(!is.na(improved_sanitation)) %>% 
  count(improved_sanitation) %>% 
  mutate(pct = round(n / sum(n) * 100, 1),
         label = paste0(pct, "%"))

ggplot(san_tab, aes(x = "", y = n, fill = factor(improved_sanitation))) +
  geom_col(width = 1) +
  coord_polar(theta = "y") +
  geom_text(aes(label = label),
            position = position_stack(vjust = 0.5), size = 4) +
  labs(
    fill = "Nhà tiêu hợp vệ sinh (0=Không, 1=Có)",
    title = "Tỷ lệ hộ có nhà tiêu hợp vệ sinh"
  ) +
  theme_void()
```

### *Biểu đồ cột so sánh theo khu vực* {.tabset .tabset-fade .tabset-pills}

#### Nước sạch

```{r bar-area-safe, echo=FALSE}
# Nước sạch theo khu vực
water_by_area <- hh_clean %>% 
  filter(!is.na(safe_water)) %>% 
  group_by(HH6, safe_water) %>% 
  summarise(n = n(), .groups = "drop") %>% 
  group_by(HH6) %>% 
  mutate(pct = n / sum(n) * 100)

ggplot(water_by_area, aes(x = factor(HH6), y = pct, fill = factor(safe_water))) +
  geom_col() +
  geom_text(aes(label = paste0(round(pct,1), "%")),
            position = position_stack(vjust = 0.5),
            color = "white", size = 4) +
  labs(
    title = "Tỷ lệ hộ sử dụng nước sạch theo khu vực",
    x = "Khu vực (1=Thành thị, 2=Nông thôn)", y = "Tỷ lệ (%)",
    fill = "Nước sạch (0=Không, 1=Có)"
  ) +
  theme_minimal()
```

#### Nhà tiêu hợp vệ sinh

```{r bar-area-san, echo=FALSE}
# Nhà tiêu theo khu vực
san_by_area <- hh_clean %>% 
  filter(!is.na(improved_sanitation)) %>% 
  group_by(HH6, improved_sanitation) %>% 
  summarise(n = n(), .groups = "drop") %>% 
  group_by(HH6) %>% 
  mutate(pct = n / sum(n) * 100)

ggplot(san_by_area, aes(x = factor(HH6), y = pct, fill = factor(improved_sanitation))) +
  geom_col() +
  geom_text(aes(label = paste0(round(pct,1), "%")),
            position = position_stack(vjust = 0.5),
            color = "white", size = 4) +
  labs(
    title = "Tỷ lệ hộ có nhà tiêu hợp vệ sinh theo khu vực",
    x = "Khu vực (1=Thành thị, 2=Nông thôn)", y = "Tỷ lệ (%)",
    fill = "Nhà tiêu hợp vệ sinh (0=Không, 1=Có)"
  ) +
  theme_minimal()
```

## **3. Kết quả phân tích hai biến**

### Kiểm định Chi-squared 

```{r chi-square}
chisq_res <- chisq.test(hh_clean$safe_water, hh_clean$any_diarrhea)
knitr::kable(as.data.frame(chisq_res$observed),
             caption = "Bảng chéo: Nước sạch và tiêu chảy ở trẻ")
chisq_res
```

### Phân tích hồi quy logistic

```{r regression}
# Hồi quy logistic
model <- glm(improved_sanitation ~ windex5 + helevel + HH6 + HC2,
             data = hh_clean,
             family = binomial)

summary(model)

```

------------------------------------------------------------------------
